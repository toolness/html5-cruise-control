<!DOCTYPE html>
<meta charset"utf-8">
<link rel="stylesheet" href="codemirror-4.2/lib/codemirror.css">
<link rel="stylesheet" href="codemirror-4.2/theme/pastel-on-dark.css">
<link rel="stylesheet" href="bootstrap3/css/bootstrap.css">
<title>HTML5 Cruise Control Demo</title>
<div class="container">
  <h1>HTML5 Cruise Control Demo</h1>
  <div class="row">
    <div class="col-sm-6" id="rendering"></div>
    <div class="col-sm-6" id="source"></div>
  </div>
  <br>
  <button class="form-control btn btn-default js-change-html" id="change-first-p">Change the first paragraph&hellip;</button>
</div>
<script src="codemirror-4.2/lib/codemirror.js"></script>
<script src="codemirror-4.2/mode/xml/xml.js"></script>
<script src="codemirror-4.2/mode/javascript/javascript.js"></script>
<script src="codemirror-4.2/mode/css/css.js"></script>
<script src="codemirror-4.2/mode/htmlmixed/htmlmixed.js"></script>
<script src="slowparse.js"></script>
<script src="jquery.js"></script>
<script>
var cm = CodeMirror($("#source")[0], {
  value: '',
  theme: 'pastel-on-dark',
  mode: 'htmlmixed'
});

function changeText(el, newText) {
  var container = document.createElement('div');
  container.textContent = newText;

  return {
    type: 'replace',
    start: el.parseInfo.openTag.end,
    end: el.parseInfo.closeTag.start,
    content: container.innerHTML
  };
}

function slowlyDeleteRange(cm, from, to, speed, cb) {
  var i = to - from;

  function deleteNextChar() {
    if (i-- == 0) return cb();
    cm.execCommand('delCharBefore');
    setTimeout(deleteNextChar, speed);
  }

  cm.setCursor(cm.posFromIndex(to));
  deleteNextChar();
}

function slowlyTypeChars(cm, start, chars, speed, cb) {
  chars = chars.split('');

  function typeNextChar() {
    if (chars.length == 0) return cb();

    cm.setCursor(cm.posFromIndex(start));
    cm.replaceRange(chars.shift(), cm.posFromIndex(start++));
    setTimeout(typeNextChar, speed);
  }

  typeNextChar();
}

function doOperation(cm, op, speed, cb) {
  var value = cm.getValue();

  cb = cb || function() {};
  cm.focus();
  if (op.type == 'replace') {
    if (speed == 0)
      setTimeout(function() {
        cm.replaceRange(op.content, cm.posFromIndex(op.start),
                        cm.posFromIndex(op.end));
        cb();
      }, 0);
    else
      slowlyDeleteRange(cm, op.start, op.end, speed, function() {
        slowlyTypeChars(cm, op.start, op.content, speed, cb);
      });
  } else throw new Error('unknown operation type: ' + op.type);
}

$.fn.extend({
  toggleDisabled: function(val) {
    if (val)
      this.attr('disabled', '');
    else
      this.removeAttr('disabled');
  }
});

cm.on('change', function() {
  var html = cm.getValue();
  var slowparse = Slowparse.HTML(document, html);
  var doc = slowparse && slowparse.document;

  $("#rendering").html(html);

  if (slowparse.error) {
    $('.js-change-html').attr('disabled', '');
  } else {
    $('.js-change-html').removeAttr('disabled');
  }

  $('.js-change-html').unbind();

  if (!doc) return;

  if (!doc.querySelector('p'))
    $('#change-first-p').attr('disabled', '');

  $('#change-first-p').click(function() {
    response = prompt('What should the paragraph say?');
    doOperation(cm, changeText(doc.querySelector('p'), response), 100);
  });
});

$(function() {
  cm.focus();

  $.get('contents.html', function(html) {
    cm.setValue(html);
  });
});
</script>