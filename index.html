<!DOCTYPE html>
<meta charset"utf-8">
<link rel="stylesheet" href="codemirror-4.2/lib/codemirror.css">
<link rel="stylesheet" href="codemirror-4.2/theme/pastel-on-dark.css">
<link rel="stylesheet" href="bootstrap3/css/bootstrap.css">
<title>HTML5 Cruise Control Demo</title>
<div class="container">
  <h1>HTML5 Cruise Control Demo</h1>
  <div class="row">
    <div class="col-sm-6" id="rendering"></div>
    <div class="col-sm-6" id="source"></div>
  </div>
  <br>
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">Cruise Control</h3>
    </div>
    <div class="panel-body">
      <p>If you don't know what to do with the code above, you can use the form below to learn how some common things are done.</p>
      <label for="change-first-img">Set the first image to a&hellip;</label>
      <select class="form-control js-change-html" id="change-first-img" autocomplete="off">
        <option value="http://placekitten.com/100/100">Cat</option>
        <option value="http://mozorg.cdn.mozilla.net/media/img/styleguide/identity/firefox/usage-logo.png">Firefox logo</option>
      </select>
      <br>
      <button class="form-control btn btn-default js-change-html" id="change-first-p">Change the first paragraph&hellip;</button>
    </div>
  </div>
  <p class="text-right"><small><a href="https://github.com/toolness/html5-cruise-control">Fork me on GitHub</a></small></p>
</div>
<script src="codemirror-4.2/lib/codemirror.js"></script>
<script src="codemirror-4.2/mode/xml/xml.js"></script>
<script src="codemirror-4.2/mode/javascript/javascript.js"></script>
<script src="codemirror-4.2/mode/css/css.js"></script>
<script src="codemirror-4.2/mode/htmlmixed/htmlmixed.js"></script>
<script src="slowparse.js"></script>
<script src="jquery.js"></script>
<script>
var inCruiseControl = false;
var cm = CodeMirror($("#source")[0], {
  value: '',
  theme: 'pastel-on-dark',
  mode: 'htmlmixed'
});

var cruiseControls = {
  'click #change-first-p': {
    selector: 'p',
    execute: function(el, control, done) {
      response = prompt('What should the paragraph say?');
      if (response === null) return done();
      doOperation(cm, changeText(el, response), 100, done);
    }
  },
  'change #change-first-img': {
    selector: 'img[src]',
    execute: function(el, control, done) {
      var src = control.val();
      var op = changeAttr(el, 'src', src);
      op.withClipboard = true;
      doOperation(cm, op, 500, done);
    }
  }
};

function changeText(el, newText) {
  var container = document.createElement('div');
  container.textContent = newText;

  return {
    type: 'replace',
    start: el.parseInfo.openTag.end,
    end: el.parseInfo.closeTag.start,
    content: container.innerHTML
  };
}

function getAttrNode(el, attr) {
  attr = attr.toLowerCase();
  for (var i = 0; i < el.attributes.length; i++) {
    var attrNode = el.attributes[i];
    if (attrNode.nodeName.toLowerCase() == attr) return attrNode;
  }
}

function changeAttr(el, attr, newSafeValue) {
  var parseInfo = getAttrNode(el, attr).parseInfo;
  var op = {
    type: 'replace',
    content: newSafeValue
  };

  if (parseInfo.value) {
    op.start = parseInfo.value.start + 1;
    op.end = parseInfo.value.end - 1;
  } else {
    op.start = op.end = parseInfo.name.end;
    op.content = '="' + newSafeValue + '"';
  }

  return op;
}

function slowlyDeleteRange(cm, from, to, speed, cb) {
  var i = to - from;

  function deleteNextChar() {
    if (i-- == 0) return cb();
    cm.execCommand('delCharBefore');
    setTimeout(deleteNextChar, speed);
  }

  cm.setCursor(cm.posFromIndex(to));
  deleteNextChar();
}

function slowlyTypeChars(cm, start, chars, speed, cb) {
  chars = chars.split('');

  function typeNextChar() {
    if (chars.length == 0) return cb();

    cm.setCursor(cm.posFromIndex(start));
    cm.replaceRange(chars.shift(), cm.posFromIndex(start++));
    setTimeout(typeNextChar, speed);
  }

  typeNextChar();
}

function doOperation(cm, op, speed, cb) {
  var value = cm.getValue();

  cb = cb || function() {};
  cm.focus();
  if (op.type == 'replace') {
    var startPos = cm.posFromIndex(op.start);
    var endPos = cm.posFromIndex(op.end);
    if (speed == 0)
      setTimeout(function() {
        cm.replaceRange(op.content, startPos, endPos);
        cb();
      }, 0);
    else if (op.withClipboard) {
      cm.setSelection(startPos, endPos);
      setTimeout(function() {
        cm.replaceRange('', startPos, endPos);
        setTimeout(function() {
          cm.replaceRange(op.content, startPos, startPos);
          cb();
        }, speed);
      }, speed);
    } else {
      slowlyDeleteRange(cm, op.start, op.end, speed, function() {
        slowlyTypeChars(cm, op.start, op.content, speed, cb);
      });
    }
  } else throw new Error('unknown operation type: ' + op.type);
}

function reparseCode() {
  if (inCruiseControl) return;
  var html = cm.getValue();
  var slowparse = Slowparse.HTML(document, html);
  var doc = slowparse && slowparse.document;
  var allControls = $('.js-change-html');

  $("#rendering").html(html);

  if (slowparse.error) {
    allControls.attr('disabled', '');
  } else {
    allControls.removeAttr('disabled');
  }

  allControls.unbind();

  if (!doc) return;

  Object.keys(cruiseControls).forEach(function(str) {
    var parts = str.split(' ');
    var eventName = parts[0];
    var control = $(parts[1]);
    var options = cruiseControls[str];
    var el = doc.querySelector(options.selector);

    if (!el)
      control.attr('disabled', '');
    else
      control.on(eventName, function(e) {
        if (inCruiseControl) return;
        inCruiseControl = true;
        options.execute(el, control, function() {
          inCruiseControl = false;
          reparseCode();
        });
      });
  });
}

cm.on('change', reparseCode);

$(function() {
  cm.focus();

  $.get('contents.html', function(html) {
    cm.setValue(html);
  });
});
</script>